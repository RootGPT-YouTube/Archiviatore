 #!/bin/bash

pausa() { sleep 2; }

clear
echo "ğŸ—‚ï¸ Benvenuto in Archiviatore!"
echo ""
echo "ğŸ‘‰ Vuoi comprimere file o cartelle? Premi 1"
echo "ğŸ‘‰ Vuoi decomprimere un archivio .tar.zst? Premi 2"
echo "ğŸ‘‰ Vuoi decriptare un archivio .7z cifrato? Premi 3"
echo ""
read -p "â¡ï¸ Inserisci la tua scelta [1/2/3]: " scelta

### â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
### ğŸ§µ OPZIONE 1: COMPRESSIONE
### â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
if [[ "$scelta" == "1" ]]; then
    echo "ğŸ“¦ Hai scelto di comprimere file o cartelle."

    if ! command -v zstd &> /dev/null; then
        echo "âŒ 'zstd' non Ã¨ installato."
        pausa
        exit 1
    fi

    if ! command -v 7z &> /dev/null && ! command -v 7za &> /dev/null; then
        echo "âŒ '7z' non trovato. Installa 7-Zip o il pacchetto 'p7zip-full'."
        pausa
        exit 1
    fi

    zipcmd=$(command -v 7z || command -v 7za)

    read -p "ğŸ“‚ Inserisci i percorsi da comprimere (separati da spazio): " -a sorgenti
    validi=()
    for e in "${sorgenti[@]}"; do
        [ -e "$e" ] && validi+=("$e") || echo "âš ï¸ '$e' non esiste, ignorato."
    done
    [ ${#validi[@]} -eq 0 ] && echo "âŒ Nessun file valido." && exit 1

    read -p "ğŸ“ Inserisci il nome dell'archivio (senza estensione) [default=~/archivio]: " archivio
    [ -z "$archivio" ] && archivio="$HOME/archivio"
    archivio="${archivio%.tar.zst}.tar.zst"

    [ -e "$archivio" ] && read -p "âš ï¸ '$archivio' esiste giÃ . Sovrascriverlo? [s/N]: " conferma && [[ ! "$conferma" =~ ^[sS]$ ]] && echo "ğŸ›‘ Compressione annullata." && exit 1

    read -p "ğŸ”§ Livello di compressione zstd (0â€“19) [default=19]: " livello
    [[ ! "$livello" =~ ^[0-9]+$ ]] || [ "$livello" -lt 0 ] || [ "$livello" -gt 22 ] && livello=19

    temp_tar=$(mktemp /tmp/temp_archive.XXXXXX.tar)
    mapfile -t filelist < <(find "${validi[@]}" -type f)
    totale=${#filelist[@]}
    echo "ğŸ“ Trovati $totale file da comprimere."

    count=0
    for file in "${filelist[@]}"; do
        ((count++))
        echo "â• [$count/$totale] $(basename "$file")"
        tar --append --file="$temp_tar" "$file"
    done

    echo "âš™ï¸ Sto comprimendo con zstd..."
    zstd -$livello "$temp_tar" -o "$archivio"
    rm -f "$temp_tar"
    echo "âœ… Archivio creato: $archivio"

    read -p "ğŸ” Vuoi proteggere l'archivio con password usando 7-Zip? [s/N]: " proteggi
    if [[ "$proteggi" =~ ^[sS]$ ]]; then
        read -s -p "ğŸ”‘ Inserisci la password: " zip_pass
        echo ""
        "$zipcmd" a -t7z -p"$zip_pass" -mhe=on "${archivio}.7z" "$archivio"
        echo "âœ… Archivio cifrato: ${archivio}.7z"
        read -p "ğŸ—‘ï¸ Vuoi eliminare l'originale .tar.zst? [s/N]: " cancella
        [[ "$cancella" =~ ^[sS]$ ]] && rm -f "$archivio" && echo "ğŸ§¹ Originale eliminato."
    fi
    echo -e "\a"

### â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
### ğŸ“¤ OPZIONE 2: DECOMPRESSIONE
### â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
elif [[ "$scelta" == "2" ]]; then
    echo "ğŸ“¦ Hai scelto di decomprimere un archivio .tar.zst."

    read -p "ğŸ“‚ Inserisci il percorso dell'archivio da estrarre: " archivio
    [ ! -e "$archivio" ] && echo "âŒ Archivio non trovato." && exit 1

    read -p "ğŸ“ Dove vuoi estrarre i file? [default=~/ArchiveTemp]: " destinazione
    [ -z "$destinazione" ] && destinazione="$HOME/ArchiveTemp"
    [ ! -d "$destinazione" ] && mkdir -p "$destinazione"

    tar -I zstd -xf "$archivio" -C "$destinazione"
    echo "âœ… File estratti in: $destinazione"

    read -p "ğŸ—‘ï¸ Vuoi eliminare l'archivio .tar.zst originale? [s/N]: " cancella
    [[ "$cancella" =~ ^[sS]$ ]] && rm -f "$archivio" && echo "ğŸ§¹ Archivio eliminato."
    echo -e "\a"

### â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
### ğŸ”“ OPZIONE 3: DECRIPTARE + ESTRARRE
### â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
elif [[ "$scelta" == "3" ]]; then
    echo "ğŸ” Hai scelto di decriptare un archivio .7z."

    if ! command -v 7z &> /dev/null && ! command -v 7za &> /dev/null; then
        echo "âŒ '7z' non Ã¨ disponibile. Installa 7-Zip o il pacchetto 'p7zip-full'."
        exit 1
    fi

    zipcmd=$(command -v 7z || command -v 7za)

    read -p "ğŸ“‚ Inserisci il percorso dell'archivio .7z da decriptare: " cifrato
    [ ! -e "$cifrato" ] && echo "âŒ Archivio .7z non trovato." && exit 1

    read -p "ğŸ“ Dove vuoi estrarre i file? [default=~/ArchiveTemp]: " destinazione
    [ -z "$destinazione" ] && destinazione="$HOME/ArchiveTemp"
    [ ! -d "$destinazione" ] && mkdir -p "$destinazione"

    echo "ğŸ”‘ Ti verrÃ  richiesta la password da 7-Zip..."
    "$zipcmd" x "$cifrato" -o"$destinazione"
    echo "âœ… File estratti in: $destinazione"

    read -p "ğŸ—‘ï¸ Vuoi eliminare l'archivio .7z originale? [s/N]: " clean
    [[ "$clean" =~ ^[sS]$ ]] && rm -f "$cifrato" && echo "ğŸ§¹ File cifrato eliminato."
    echo -e "\a"

### â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
### âŒ SCELTA NON VALIDA
### â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
else
    echo "âŒ Scelta non riconosciuta. Riprova scegliendo 1, 2 o 3."
    exit 1
fi
